name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run type checking
        run: pnpm typecheck

      - name: Run linting
        run: pnpm lint

      - name: Build extension
        run: pnpm build

      - name: Create extension zip
        run: |
          cd dist
          zip -r ../instagram-to-arena-${{ github.ref_name }}.zip .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: instagram-to-arena-${{ github.ref_name }}.zip
          generate_release_notes: true
          body: |
            ## Installation

            1. Download `instagram-to-arena-${{ github.ref_name }}.zip` from this release
            2. Unzip the file to a folder on your computer
            3. Open Chrome and go to `chrome://extensions/`
            4. Enable "Developer mode" (toggle in top right)
            5. Click "Load unpacked" and select the unzipped folder
            6. The extension is now installed!

            ## Setup

            1. Click the extension icon and go to Options
            2. Enter your Are.na access token
            3. Navigate to an Instagram post and click the extension to connect images to your Are.na channels
